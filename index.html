<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carbon Footprint - USA</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.148.0/three.min.js"></script>
  </head>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .legend {
      margin-top: 0.5rem;
      text-align: center;
      font-size: 0.8rem;
    }
    .legend-bar {
      width: 200px;
      height: 12px;
      margin: 0 auto 4px;
    }
    .legend-labels {
      display: flex;
      justify-content: space-between;
      width: 200px;
      margin: 0 auto;
    }
    .zip-label {
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }
    .active-category {
      background-color: #3e6415 !important;
    }
    #globe-container {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
  </style>

  <body>
    <div id="globe-container"></div>
    <header>
      <h1 style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)">
         Carbon Footprint by United States of America Counties
      </h1>
    </header>
    <main>
      <section id="section-1" center>
        <section>
          <center>
            <h3
              style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)"
            >
              Explore the Carbon Footprint of the United States‚ÄîCounty by County
            </h3>
            <p
              style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)"
            >
              This interactive webpage reveals a detailed portrait of carbon
              emissions across the U.S., offering two distinct but
              interconnected perspectives: on the left, the average carbon
              footprint per person in each county, and on the right, the total
              carbon footprint generated by the county as a whole. Together,
              these maps uncover compelling contrasts‚Äîfor instance, some densely
              populated counties may show relatively low per-person emissions,
              yet contribute significantly to the national total due to their
              size. Others may have high per-capita emissions but low overall
              impact due to smaller populations. These side-by-side views
              provide a deeper understanding of how individual behavior and
              population scale contribute to climate change at the local level.
            </p>
          </center>
          <div class="containercb">
            <label><input type="checkbox" id="service" /> Services</label>
            <label><input type="checkbox" id="goods" /> Goods</label>
            <label><input type="checkbox" id="food" /> Food</label>
            <label><input type="checkbox" id="housing" /> Housing</label>
            <label><input type="checkbox" id="transport" /> Transport</label>
          </div>
          <div class="container">
            <div class="map">
              <h2>Co2 Footprint per person</h2>
              <h4>Select one or more categories above</h4>
              <p>
                Comparison of average footprint of an indiviual in each countyüßç
              </p>
              <svg id="us-map-1" width="680" height="300"></svg>
              <!-- Tooltip for interactivity -->
              <div class="tooltip" id="map_1_tooltip"></div>
              <div class="legend" id="legend-per-person"></div>
              <p id="county-label-1" class="zip-label">County Selected:</p>
              <p></p>
              <select
                id="zip-select-1"
                class="floating-dropdown"
                style="display: none"
              ></select>
            </div>
            <div class="map">
              <h2>Total Co2 footprint</h2>
              <h4>Select one or more categories above</h4>
              <p>Comparison of total footprint across counties</p>
              <svg id="us-map-2" width="680" height="300"></svg>
              <!-- Tooltip for interactivity -->
              <div class="tooltip" id="map_2_tooltip"></div>
              <div class="legend" id="legend-total"></div>
              <p id="county-label-2" class="zip-label">County Selected:</p>
              <select
                id="zip-select-2"
                class="floating-dropdown"
                style="display: none"
              ></select>
            </div>
          </div>
        </section>
        <h1 style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)">
          Activities that affect CO2 Footprint in the County
        </h1>
        <center>
          <p style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)">
            Select any county above from either map.
          </p>
        </center>
        <div class="container">
          <div class="map">
            <h1>
              Co2 Footprint per person based on the county selected above.
            </h1>
            <p id="zip-selected-label-1" class="zip-label"></p>
            <canvas id="zip-bars-1" class="bar-chart"></canvas>
          </div>

          <div class="map">
            <h1>
              Total Co2 footprint based on the county selected above.
            </h1>
            <p id="zip-selected-label-2" class="zip-label"></p>
            <canvas id="zip-bars-2" class="bar-chart"></canvas>
          </div>
        </div>
      </section>

      <section id="section-2">
        <center>
          <h1 style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)">
            Questions about your interpretation
          </h1>
        </center>
        <div class="subsections">
          <div class="subsection">
            <h3>Question 1</h3>
            <p>Which region has the highest carbon footprint?</p>
            <label><input type="radio" name="q1" value="west" /> West</label
            ><br />
            <label
              ><input type="radio" name="q1" value="midwest" /> Midwest</label
            ><br />
            <label><input type="radio" name="q1" value="south" /> South</label
            ><br />
            <label
              ><input type="radio" name="q1" value="northeast" />
              Northeast</label
            >
          </div>
          <div class="subsection">
            <h3>Question 2</h3>
            <p>Which category contributes most to the footprint?</p>
            <label
              ><input type="radio" name="q2" value="services" /> Services</label
            ><br />
            <label><input type="radio" name="q2" value="goods" /> Goods</label
            ><br />
            <label
              ><input type="radio" name="q2" value="housing" /> Housing</label
            ><br />
            <label
              ><input type="radio" name="q2" value="transport" />
              Transport</label
            ><br />
            <label><input type="radio" name="q2" value="food" /> Food</label>
          </div>
          <div class="subsection">
            <h3>Question 3</h3>
            <p>Is the footprint per person higher in rural or urban areas?</p>
            <label><input type="radio" name="q3" value="rural" /> Rural</label
            ><br />
            <label><input type="radio" name="q3" value="urban" /> Urban</label>
          </div>
          <div class="subsection">
            <h3>Question 4</h3>
            <p>Which state has the lowest carbon footprint?</p>
            <label
              ><input type="radio" name="q4" value="vermont" /> Vermont</label
            ><br />
            <label><input type="radio" name="q4" value="texas" /> Texas</label
            ><br />
            <label
              ><input type="radio" name="q4" value="california" />
              California</label
            ><br />
            <label
              ><input type="radio" name="q4" value="florida" /> Florida</label
            >
          </div>
          <div class="subsection">
            <h3>Question 5</h3>
            <p>
              Are transportation emissions generally higher in coastal or inland
              states?
            </p>
            <label
              ><input type="radio" name="q5" value="coastal" /> Coastal</label
            ><br />
            <label
              ><input type="radio" name="q5" value="inland" /> Inland</label
            >
          </div>
        </div>
        <div class="submit-container">
          <button id="submit-button">Submit Answers</button>
        </div>
      </section>
      <section id="section-3">
        <center>
          <h2 style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)">
            Admin Only
          </h2>
          <p style="color: white; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6)">
            Download Survery Data
          </p>
          <button id="download-csv-button">
            Download All Survey Responses
          </button>
        </center>
      </section>
    </main>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script>
      let activityCharts = {};
      // Survey Response
      function collectSurveyResponses() {
        const responses = {};
        for (let i = 1; i <= 5; i++) {
          const selected = document.querySelector(
            `input[name="q${i}"]:checked`
          );
          responses[`q${i}`] = selected ? selected.value : "";
        }
        responses.timestamp = new Date().toISOString(); // optional
        return responses;
      }

      // Save each attempt to localStorage
      function storeSurveyAttempt(data) {
        const prev = JSON.parse(
          localStorage.getItem("carbonSurveyAll") || "[]"
        );
        prev.push(data);
        localStorage.setItem("carbonSurveyAll", JSON.stringify(prev));
      }

      // Export all attempts as CSV
      function downloadAllSurveyAttempts() {
        const allData = JSON.parse(
          localStorage.getItem("carbonSurveyAll") || "[]"
        );
        if (allData.length === 0) {
          alert("No survey responses found.");
          return;
        }

        const headers = Object.keys(allData[0]);
        const csvRows = [headers.join(",")];

        allData.forEach((row) => {
          csvRows.push(headers.map((key) => row[key]).join(","));
        });

        const csvContent = csvRows.join("\n");
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "all_survey_responses.csv";
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Event listeners
      document.getElementById("submit-button").addEventListener("click", () => {
        const answers = collectSurveyResponses();
        storeSurveyAttempt(answers);
        showStatus("Answers saved!");
      });

      document
        .getElementById("download-csv-button")
        .addEventListener("click", () => {
          const password = prompt("Enter password to download responses:");
          const correctPassword = "CS573KCD";

          if (password === correctPassword) {
            downloadAllSurveyAttempts();
          } else {
            alert("Incorrect password. Access denied.");
          }
        });

      // Map Stuff

      const source2 =
        "https://raw.githubusercontent.com/ChrisGeorge-fintech/data/refs/heads/main/CountyextCarbonData.csv";
      let fetchedData = null; // Global variable to store the data

      async function fetchData() {
        try {
          const response = await fetch(source2);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.text();
          fetchedData = data; // Save the data for reuse
          console.log("Data fetched and saved:");
        } catch (error) {
          console.error("Error fetching the data:", error);
        }
      }

      class Zipcode {
        constructor(
          state,
          county,
          transport,
          housing,
          food,
          goods,
          services,
          electricity,
          gas,
          fuel,
          vehicleMiles,
          population,
          households
        ) {
          this.state = state;
          this.county = county.trim();
          this.Transport = transport * households;
          this.Housing = housing * households;
          this.Food = food * households;
          this.Goods = goods * households;
          this.Services = services * households;
          this.electricity = electricity * households;
          this.gas = gas * households;
          this.fuel = fuel * households;
          this.vehicleMiles = vehicleMiles * households;
          this.Population = population;
          this.households = households;
          this.I_Transport = (transport * households) / population;
          this.I_Housing = (housing * households) / population;
          this.I_Food = (food * households) / population;
          this.I_Goods = (goods * households) / population;
          this.I_Services = (services * households) / population;
        }
        toString() {
          return `State: ${this.state}, County: ${this.county}, Population: ${this.Population}, Households: ${this.households}, Transport: ${this.Transport}, Housing: ${this.Housing}, Food: ${this.Food}, Goods: ${this.Goods}, Services: ${this.Services}`;
        }
        toJSON() {
          return {
            longitude: this.longitude,
            latitude: this.latitude,
            city: this.city,
            state: this.state,
            county: this.county,
            Transport: this.Transport,
            Housing: this.Housing,
            Food: this.Food,
            Goods: this.Goods,
            Services: this.Services,
            electricity: this.electricity,
            gas: this.gas,
            fuel: this.fuel,
            vehicleMiles: this.vehicleMiles,
            Population: this.Population,
            households: this.households,
          };
        }
        tot_activities() {
          return {
            electricity: this.electricity,
            gas: this.gas,
            fuel: this.fuel,
            vehicleMiles: this.vehicleMiles,
          };
        }
        ind_activities() {
          return {
            electricity: this.electricity / this.Population,
            gas: this.gas / this.Population,
            fuel: this.fuel / this.Population,
            vehicleMiles: this.vehicleMiles / this.Population,
          };
        }
      }

      class MyCollection {
        constructor() {
          this.collection = new Set();
        }

        add(element) {
          this.collection.add(element);
        }

        remove(element) {
          if (this.collection.has(element)) {
            this.collection.delete(element);
          } else {
            throw new Error("Element not found in the collection.");
          }
        }

        size() {
          return this.collection.size;
        }

        toString() {
          return Array.from(this.collection)
            .map((item) => item.toString())
            .toString();
        }

        // Method to use all the records in a supplied worksheet as the collection
        populateCollection(data) {
          this.collection.clear();
          const rows = data.split("\n");
          const headers = rows[0].split(",");
          const indices = {
            state: headers.indexOf("State"),
            county: headers.indexOf("County"),
            transport: headers.indexOf("s_Transport (tCO2e/yr)"),
            housing: headers.indexOf("s_Housing (tCO2e/yr)"),
            food: headers.indexOf("s_Food (tCO2e/yr)"),
            goods: headers.indexOf("s_Goods (tCO2e/yr)"),
            services: headers.indexOf("s_Services (tCO2e/yr)"),
            electricity: headers.indexOf("s_electricity (kWh)"),
            gas: headers.indexOf("s_Nat. Gas (cu.ft.)"),
            fuel: headers.indexOf("s_FUELOIL (gallons)"),
            vehicleMiles: headers.indexOf("s_Vehicle miles traveled"),
            population: headers.indexOf("Population"),
            households: headers.indexOf("Households"),
          };

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i].split(",");
            if (row.length === headers.length) {
              const element = new Zipcode(
                row[indices.state],
                row[indices.county],
                parseFloat(row[indices.transport]),
                parseFloat(row[indices.housing]),
                parseFloat(row[indices.food]),
                parseFloat(row[indices.goods]),
                parseFloat(row[indices.services]),
                parseFloat(row[indices.electricity]),
                parseFloat(row[indices.gas]),
                parseFloat(row[indices.fuel]),
                parseFloat(row[indices.vehicleMiles]),
                parseInt(row[indices.population]),
                parseInt(row[indices.households])
              );
              this.collection.add(element);
            }
          }
          return `Collection populated with ${this.collection.size} elements.`;
        }

        clear() {
          this.collection.clear();
          return this.collection;
        }

        carbonFootprint(
          mode,
          t = null,
          h = null,
          f = null,
          g = null,
          s = null
        ) {
          const carbonFootprint = {};
          if (mode === "total") {
            this.collection.forEach((zip) => {
              let footprint = 0;
              if (t === 1) footprint += zip.Transport;
              if (h === 1) footprint += zip.Housing;
              if (f === 1) footprint += zip.Food;
              if (g === 1) footprint += zip.Goods;
              if (s === 1) footprint += zip.Services;
              carbonFootprint[zip.county] = {
                footprint: footprint / 1000,
                state: zip.state,
                county: zip.county,
                population: zip.Population,
                households: zip.households,
              };
            });
            return carbonFootprint;
          }
          if (mode === "individual") {
            this.collection.forEach((zip) => {
              let footprint = 0;
              if (t === 1) footprint += zip.I_Transport;
              if (h === 1) footprint += zip.I_Housing;
              if (f === 1) footprint += zip.I_Food;
              if (g === 1) footprint += zip.I_Goods;
              if (s === 1) footprint += zip.I_Services;
              carbonFootprint[zip.county] = {
                footprint: footprint,
                state: zip.state,
                county: zip.county,
                population: zip.Population,
                households: zip.households,
              };
            });
            return carbonFootprint;
          }
        }
      }

      myproject = new MyCollection();
      fetchData()
        .then(() => {
          console.log("Data fetched successfully");
          if (fetchedData) {
            myproject.populateCollection(fetchedData);
            console.log(myproject.carbonFootprint("total", 1, 1, 1, 1, 1));
          } else {
            console.error("No data available to populate the collection");
          }
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });

      // ----- GLITCH STARTER PROJECT HELPER CODE -----

      // Open file when the link in the preview is clicked
      let goto = (file, line) => {
        window.parent.postMessage(
          {
            type: "glitch/go-to-line",
            payload: { filePath: file, line: line },
          },
          "*"
        );
      };

      // Get the file opening button from its class name
      const filer = document.querySelectorAll(".fileopener");
      filer.forEach((f) => {
        f.onclick = () => {
          goto(f.dataset.file, f.dataset.line);
        };
      });

      /**
       * Renders a choropleth map of the USA by counties.
       * @param {string} svgid - The ID of the SVG container.
       * @param {string} mode - The mode for carbon footprint calculation ('total' or 'individual').
       * @param {number} t - Include transport in the calculation (1 or 0).
       * @param {number} h - Include housing in the calculation (1 or 0).
       * @param {number} f - Include food in the calculation (1 or 0).
       * @param {number} g - Include goods in the calculation (1 or 0).
       * @param {number} s - Include services in the calculation (1 or 0).
       */

      const checkboxes = document.querySelectorAll(
        ".containercb input[type='checkbox']"
      );
      const categories = ["Transport", "Housing", "Food", "Goods", "Services"];

      function getSelectedCategories() {
        // Map the checkbox states to 1 (checked) or 0 (unchecked)
        return Array.from(checkboxes).map((checkbox) =>
          checkbox.checked ? 1 : 0
        );
      }

      function updateMaps() {
        const selectedCategories = getSelectedCategories();
        render_map("#us-map-1", "individual", ...selectedCategories);
        render_map("#us-map-2", "total", ...selectedCategories);
      }

      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", updateMaps);
      });

      // Initial render
      updateMaps();

      function render_map(svgid, mode, t, h, f, g, s) {
        // Set up SVG dimensions
        const width = 500;
        const height = 300;

        const dropdown1 = d3.select("#zip-select-1");
        const dropdown2 = d3.select("#zip-select-2");
        const barContainer1 = d3.select("#zip-bars-1");
        const barContainer2 = d3.select("#zip-bars-2");
        const label1 = document.getElementById("zip-selected-label-1");
        const label2 = document.getElementById("zip-selected-label-2");
        const countyLabel1 = document.getElementById("county-label-1");
        const countyLabel2 = document.getElementById("county-label-2");

        // Create an SVG container
        const svg = d3
          .select(svgid)
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        // Define a geographic projection
        const projection = d3
          .geoAlbersUsa()
          .scale(650)
          .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        // Tooltip for interactivity
        const tooltip = d3.select(".tooltip");
        //        if (tooltip.empty()) {
        //        console.warn("Tooltip element not found in the DOM.");
        //      return;
        //  }

        // Helper function for tooltip styling
        function styleTooltip(tooltip, event, countyName, value, stateName) {
          tooltip
            .style("opacity", 1)
            .html(
              `County: ${countyName}<br>Population: ${value}<br>State: ${stateName}`
            )
            .style("left", `${event.pageX + 20}px`)
            .style("top", `${event.pageY - 260}px`);
        }

        // Create a group for the map content
        const mapGroup = svg.append("g").attr("class", "map-group");

        Promise.resolve(myproject.carbonFootprint(mode, t, h, f, g, s)); // Use already fetched data to process carbon footprint
        // Load data and render the map
        Promise.all([
          d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json"), // GeoJSON data for counties
          fetchData().then(() =>
            myproject.carbonFootprint(mode, t, h, f, g, s)
          ), // Fetch and process carbon footprint data
        ])
          .then(([us, carbonData]) => {
            // Map carbon footprint data to counties and cache min/max values
            let minValue = 0;
            let maxValue = 50;
            const dataByCounty = new Map(
              Object.entries(carbonData).map(([county, values]) => {
                const footprint = values.footprint;
                const state = values.state;
                const population = values.population;
                if (footprint < minValue) minValue = footprint;
                if (footprint > maxValue) maxValue = footprint;
                return [county.toUpperCase(), [footprint, state, population]];
              })
            );

            // Define a color scale
            const color = d3
              .scaleLinear()
              .domain(
                d3
                  .range(0, 1.1, 0.1)
                  .map((d) => minValue + d * (maxValue - minValue))
              )
              .range([
                "white",
                "lightyellow",
                "yellow",
                "orange",
                "darkorange",
                "orangered",
                "red",
                "darkred",
                "maroon",
                "brown",
              ]);

            // Draw counties
            // Bind GeoJSON features to SVG paths for rendering counties
            svg
              .append("g")
              .selectAll("path")
              .data(topojson.feature(us, us.objects.counties).features)
              .join("path")
              .attr("stroke", "#000") // Changed to black
              .attr("stroke-width", 0.5)
              .attr("fill", (d) => {
                const countyName = d.properties.name?.toUpperCase();
                const value = dataByCounty.get(countyName) || 0;
                return color(value[0]);
              })
              .attr("d", path)
              .on("mouseover", (event, d) => {
                const countyName = d.properties.name?.toUpperCase();
                const value = dataByCounty.get(countyName)[0] || "No data";
                const stateName = dataByCounty.get(countyName)[1] || "Unknown";
                const population = dataByCounty.get(countyName)[2] || "Unknown";

                styleTooltip(
                  tooltip,
                  event,
                  countyName,
                  population,
                  stateName,
                  population
                );
              })
              .on("mouseout", () => tooltip.style("opacity", 0))

              .on("click", (event, d) => {
                const county = d.properties.name?.toUpperCase();
                countyLabel2.textContent = `County Selected: ${county}`;
                countyLabel1.textContent = `County Selected: ${county}`;
                render_activities("zip-bars-1", county, "individual");
                render_activities("zip-bars-2", county, "total");

                //const zips = databyCounty.get(countyName);

                //(z) => z.CountyName.toUpperCase() === county
                //);
                //if (zips.length === 0) return;
              });

            renderLegend("legend-total", color, "");
            renderLegend("legend-per-person", color, "");

            // Add borders for states
            svg
              .append("path")
              .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
              .attr("fill", "none")
              .attr("stroke", "#000")
              .attr("stroke-width", 1.5)
              .attr("d", path);
          })
          .catch((error) => {
            console.error("Error loading data:", error);
          });
        console.log("Map rendered");
      }

      function render_activities(ccontainer, selectedcounty, mode) {
        Promise.all([
          fetchData().then(() => {
            console.log("Data fetched successfully");
            if (fetchedData) {
              myproject.populateCollection(fetchedData);
              return Array.from(myproject.collection);
            } else {
              console.error("No data available to populate the collection");
            }
            //console.log(mylist[0].activities());
          }), // Fetch and process carbon footprint data
        ]).then(([cpackage]) => {
          const scountyName = selectedcounty;

          const firstObject = Array.isArray(cpackage)
            ? cpackage.find((item) => item.county === scountyName) || {}
            : {}; // Search for the specific county or return an empty object

          let activities = {};
          if (mode === "total") {
            activities = firstObject.tot_activities
              ? firstObject.tot_activities()
              : {}; // Safely get activity data
          }
          if (mode === "individual") {
            activities = firstObject.ind_activities
              ? firstObject.ind_activities()
              : {}; // Safely get activity data
          }

          // Prepare data for the chart
          const labels = Object.keys(activities); // Activity names (e.g., electricity, gas, etc.)
          const values = Object.values(activities); // Corresponding values

          //container.html("")

          // Create the bar chart
          const ctx = document.getElementById(ccontainer).getContext("2d");
          // Add emojis to the labels
          const labelsWithEmojis = labels.map((label) => {
            switch (label.toLowerCase()) {
              case "electricity":
                return "‚ö° Electricity";
              case "gas":
                return "üî• Gas";
              case "fuel":
                return "‚õΩ Fuel";
              case "vehicle miles":
                return "üöó Vehicle Miles";
              case "food":
                return "üçé Food";
              case "housing":
                return "üè† Housing";
              case "transport":
                return "üöå Transport";
              case "services":
                return "üíº Services";
              case "goods":
                return "üõçÔ∏è Goods";
              case "vehiclemiles":
                return "üöó Vehicle Miles";
              default:
                return label; // Keep the original label if no match
            }
          });

          if (activityCharts[ccontainer]) {
            activityCharts[ccontainer].destroy();
          }
          activityCharts[ccontainer] = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labelsWithEmojis, // Use the updated labels with emojis
              datasets: [
                {
                  label: "Scaled Activity Value",
                  data: values, // Corresponding values
                  backgroundColor: [
                    "rgba(75, 192, 192, 0.7)",
                    "rgba(54, 162, 235, 0.7)",
                    "rgba(255, 206, 86, 0.7)",
                    "rgba(153, 102, 255, 0.7)",
                    "rgba(255, 99, 132, 0.7)",
                  ],
                  borderColor: [
                    "rgba(75, 192, 192, 1)",
                    "rgba(54, 162, 235, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(153, 102, 255, 1)",
                    "rgba(255, 99, 132, 1)",
                  ],
                  borderWidth: 2,
                  hoverBackgroundColor: [
                    "rgba(75, 192, 192, 1)",
                    "rgba(54, 162, 235, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(153, 102, 255, 1)",
                    "rgba(255, 99, 132, 1)",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false,
                  position: "top",
                  labels: {
                    font: {
                      size: 14,
                      family: "Arial, sans-serif",
                      weight: "bold",
                    },
                    color: "#333",
                  },
                },
                tooltip: {
                  enabled: true,
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  titleFont: {
                    size: 16,
                    weight: "bold",
                  },
                  bodyFont: {
                    size: 14,
                  },
                  bodyColor: "#fff",
                  borderColor: "#ccc",
                  borderWidth: 1,
                },
              },
              scales: {
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    font: {
                      size: 12,
                      family: "Arial, sans-serif",
                    },
                    color: "#333",
                  },
                },
                y: {
                  beginAtZero: true,
                  grid: {
                    color: "rgba(200, 200, 200, 0.2)",
                    borderDash: [5, 5],
                  },
                  ticks: {
                    font: {
                      size: 12,
                      family: "Arial, sans-serif",
                    },
                    color: "#333",
                  },
                },
              },
              animation: {
                duration: 1500,
                easing: "easeOutBounce",
              },
            },
          });
        });
      }

      function renderLegend(selector, colorScale, label) {
        const container = document.getElementById(selector);
        container.innerHTML = `<strong>${label}</strong><br/>`;

        const canvas = document.createElement("canvas");
        canvas.width = 200;
        canvas.height = 12;
        canvas.className = "legend-bar";
        const ctx = canvas.getContext("2d");
        const domain = colorScale.domain();

        for (let i = 0; i < 200; i++) {
          ctx.fillStyle = colorScale(
            domain[1] + (i / 200) * (domain[8] - domain[0])
          );
          ctx.fillRect(i, 0, 1, 12);
        }
        container.appendChild(canvas);

        const labels = document.createElement("div");
        labels.className = "legend-labels";
        labels.innerHTML = `<span>${"lowest"}</span><span>${"highest"}</span>`;
        container.appendChild(labels);
      }

      function renderBars(container, zipEntry, labelEl) {
        labelEl.textContent = `ZIP Code Selected: ${zipEntry.zip}`;

        const categories = [
          { key: "electricity (kWh)", label: "Electricity(kWh)" },
          { key: "Nat. Gas (cu.ft.)", label: "Nat. Gas(cu.ft.)" },
          { key: "FUELOIL (gallons)", label: "Fuel Oil(gallons)" },
          { key: "Vehicle miles traveled", label: "Miles" },
        ];

        container.html(""); // clear chart

        categories.forEach((cat) => {
          const value = +zipEntry[cat.key] || 0;

          const barWrapper = container
            .append("div")
            .attr("class", "bar-wrapper");

          barWrapper
            .append("div")
            .attr("class", "bar")
            .style("height", `${Math.min(value / 2, 150)}px`)
            .text(Math.round(value));

          barWrapper.append("div").attr("class", "bar-label").text(cat.label);
        });
      }
      // Globe Script
      const container = document.getElementById("globe-container");

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x536878);
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.z = 2.5;

      const renderer = new THREE.WebGLRenderer({
        alpha: true,
        antialias: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      const textureLoader = new THREE.TextureLoader();

      const earthTexture = textureLoader.load(
        "https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"
      );
      const bumpMap = textureLoader.load(
        "https://threejs.org/examples/textures/planets/earth_bump_2048.jpg"
      );
      const specMap = textureLoader.load(
        "https://threejs.org/examples/textures/planets/earth_specular_2048.jpg"
      );

      const geometry = new THREE.SphereGeometry(1, 64, 64);
      const material = new THREE.MeshPhongMaterial({
        map: earthTexture,
        bumpMap: bumpMap,
        bumpScale: 0.05,
        specularMap: specMap,
        specular: new THREE.Color("gray"),
      });

      const globe = new THREE.Mesh(geometry, material);
      scene.add(globe);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5, 3, 5);
      scene.add(light);

      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);

      function animate() {
        requestAnimationFrame(animate);
        globe.rotation.y += 0.001;
        renderer.render(scene, camera);
      }

      animate();

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>

    <footer>
      <center>
        <p>
          ¬© 2025 Carbon Footprint Visualizer | Made by Kayla Afonseca, Christian
          George, and Daniel Onyema
        </p>
      </center>
    </footer>
  </body>
</html>
